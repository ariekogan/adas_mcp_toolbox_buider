# Session Context: Skill Wiring Implementation

**Last Updated:** January 14, 2026
**Status:** Phase 1 Implementation COMPLETE
**Repos:**
- Skill Builder: `/Users/arie/Projects/adas_mcp_toolbox_builder`
- Core ADAS: `/Users/arie/Projects/ai-dev-assistant`

---

## 1. What We're Building

**Goal:** Connect Skills defined in Skill Builder to Core ADAS runtime execution.

```
┌─────────────────────┐         ┌─────────────────────┐
│   SKILL BUILDER     │         │     CORE ADAS       │
│                     │         │                     │
│  Define domain      │  YAML   │  bootstrapSkill()   │
│  Define tools       │ ──────► │  Pre-tool Gate      │
│  Define guardrails  │ export  │  Finalization Gate  │
│  Define workflows   │         │  Reply Polisher     │
└─────────────────────┘         └─────────────────────┘
```

---

## 2. What's Done

### Core ADAS (ai-dev-assistant) - COMPLETE

All v1 implementation is done and committed:

| Component | File | Status |
|-----------|------|--------|
| Skill Bootstrap | `apps/backend/worker/skillBootstrap.js` | Done |
| Pre-tool Gate | `apps/backend/worker/runner/executeToolStep.js` | Done |
| Finalization Gate | `apps/backend/worker/finalizationGate.js` | Done |
| RV2 Guardrails Injection | `apps/backend/worker/buildAgentState.js` | Done |
| Reply Polisher + Persona | `apps/backend/utils/polishRenderer.js` | Done |
| Metrics Logging | Added to finalizationGate.js | Done |
| Tests | All test files created | Done |

**Git Status:** Tagged as "Stable before domain-skills wiring"

### Skill Builder (adas_mcp_toolbox_builder) - IN PROGRESS

| Item | Status |
|------|--------|
| Future Refinements doc | Done (`WIP/Skill_Wiring_Future_Refinements.md`) |
| Export Implementation Plan | Done (`WIP/Skill_Export_Implementation_Plan.md`) |
| YAML Export Enhancement | **DONE** (`apps/backend/src/services/export.js`) |

---

## 3. Blocker RESOLVED

**Export now produces correct YAML format** for Core ADAS consumption.

### Gap Analysis (RESOLVED)

| Field | Skill Builder Exports | Core ADAS Expects | Status |
|-------|----------------------|-------------------|--------|
| `policy.approvals` | YES | YES | **DONE** |
| `engine.finalization_gate` | YES | YES | **DONE** |
| `output_contract` | YES | YES | **DONE** |
| `persona` (top-level) | YES (copied from role) | Top-level | **DONE** |

---

## 4. Next Step: Update generateDomainYaml()

**File:** `/apps/backend/src/services/export.js`

### Changes Needed

#### 1. Add `persona` at top level (line ~307)
```javascript
// After role section
if (domain.role?.persona) {
  lines.push(`persona: ${yamlString(domain.role.persona)}`);
  lines.push(``);
}
```

#### 2. Add `policy.approvals` section (line ~460)
```javascript
// After workflows section
if (domain.policy?.approvals?.length > 0) {
  lines.push(`  approvals:`);
  for (const approval of domain.policy.approvals) {
    lines.push(`    - tool_id: ${approval.tool_id}`);
    // Convert conditions to "when" string
    if (approval.conditions?.length > 0) {
      const when = approval.conditions.map(c =>
        `${c.field} ${c.operator} ${c.value}`
      ).join(' AND ');
      lines.push(`      when: ${yamlString(when)}`);
    }
    if (approval.approver) {
      lines.push(`      approver: ${approval.approver}`);
    }
  }
}
```

#### 3. Add `engine.finalization_gate` section (line ~487)
```javascript
// After engine.max_tokens
lines.push(`  finalization_gate:`);
lines.push(`    enabled: ${domain.engine?.finalization_gate?.enabled ?? true}`);
lines.push(`    max_retries: ${domain.engine?.finalization_gate?.max_retries ?? 2}`);
```

#### 4. Add `output_contract` section (end of function)
```javascript
// Before final return
if (domain.output_contract?.required_fields?.length > 0) {
  lines.push(``);
  lines.push(`# Output Contract for Finalization Gate`);
  lines.push(`output_contract:`);
  lines.push(`  required_fields:`);
  for (const field of domain.output_contract.required_fields) {
    lines.push(`    - ${yamlString(field)}`);
  }
}
```

---

## 5. Expected YAML Output (Target)

```yaml
# Generated by ADAS Skill Builder
id: "dom_abc12345"
name: "Customer Support Agent"
version: "0.1.0"

# Top-level persona for Reply Polisher
persona: "You are a helpful customer service agent..."

problem:
  statement: "Handle customer billing inquiries"
  goals:
    - "Resolve billing questions"

tools:
  - name: "process_refund"
    description: "Process a refund"
    inputs:
      - name: "amount"
        type: "number"
        required: true
    policy:
      allowed: "conditional"
      requires_approval: "conditional"
      condition: "amount > 500"

policy:
  guardrails:
    never:
      - "Never share payment card numbers"
    always:
      - "Always verify customer identity"

  workflows:
    - name: "refund_process"
      steps:
        - "verify_identity"
        - "process_refund"
      required: true

  approvals:
    - tool_id: "process_refund"
      when: "amount > 500"
      approver: "supervisor"

output_contract:
  required_fields:
    - "resolution_status"
    - "next_steps"

engine:
  model: "default"
  temperature: 0.7
  finalization_gate:
    enabled: true
    max_retries: 2
```

---

## 6. After Export Fix - Test Flow

1. Create domain in Skill Builder with tools, guardrails, workflows
2. Export YAML via `/api/export/:domainId`
3. Copy YAML to Core ADAS `/skills/` directory (or configure path)
4. Run Core ADAS job with `skillSlug` parameter
5. Verify in logs:
   - `skill.bootstrap.complete` with correct counts
   - Guardrails appear in RV2 prompt
   - Pre-tool gate checks work
   - Finalization gate runs

---

## 7. Key Files Reference

### Skill Builder
| Purpose | Path |
|---------|------|
| YAML Export | `/apps/backend/src/services/export.js` |
| Domain Types | `/apps/backend/src/types/DraftDomain.js` |
| Default Values | `/apps/backend/src/utils/defaults.js` |
| Store (persistence) | `/apps/backend/src/store/domains.js` |
| Export API | `/apps/backend/src/routes/export.js` |

### Core ADAS
| Purpose | Path |
|---------|------|
| Skill Bootstrap | `/apps/backend/worker/skillBootstrap.js` |
| Pre-tool Gate | `/apps/backend/worker/runner/executeToolStep.js` |
| Finalization Gate | `/apps/backend/worker/finalizationGate.js` |
| RV2 Guardrails | `/apps/backend/worker/buildAgentState.js` |
| Reply Polisher | `/apps/backend/utils/polishRenderer.js` |

---

## 8. Documentation Created

| Doc | Purpose | Location |
|-----|---------|----------|
| Future Refinements | v2 backlog (judge rubric, metrics, etc.) | `WIP/Skill_Wiring_Future_Refinements.md` |
| Export Implementation Plan | Detailed tasks for YAML export | `WIP/Skill_Export_Implementation_Plan.md` |
| This Document | Session context for continuity | `WIP/Session_Context_Skill_Wiring.md` |

---

## 9. ChatGPT Collaboration Summary

During this session, ChatGPT provided:

1. **Risk Analysis** - Identified 3 risks (guardrail tiers, approval parsing, gate scope)
2. **Final Alignment Judge Rubric** - Complete scoring system for "correct but far away"
3. **Judge Prompts** - Three versions (Full, Rich, Lite ~70 tokens)
4. **Replan Instruction Template** - reason_code → fix_mode mapping
5. **Metrics Dashboard Spec** - Events, panels, alerting, tuning playbook

All captured in `WIP/Skill_Wiring_Future_Refinements.md` Section 9.

---

## 10. Commands to Resume

### In Skill Builder repo:
```bash
cd /Users/arie/Projects/adas_mcp_toolbox_builder

# See current export
cat apps/backend/src/services/export.js

# Check WIP docs
ls WIP/
```

### In Core ADAS repo:
```bash
cd /Users/arie/Projects/ai-dev-assistant

# See skill bootstrap
cat apps/backend/worker/skillBootstrap.js

# See what YAML fields it reads
grep -n "skill\." apps/backend/worker/skillBootstrap.js
```

---

## 11. Decision Log

| Decision | Rationale |
|----------|-----------|
| Finalization Gate is separate from Reply Polisher | Gate validates, Polisher formats |
| ~100 tokens for RV2 guardrails | Minimize prompt pollution |
| Max 2 retries in gate | Prevent infinite loops |
| v2 features deferred | Need real-world data first |
| Metrics logging added to v1 | Collect data for v2 decisions |

---

## 12. Open Questions

1. **Where should exported YAML live?** (file path, API endpoint, database)
2. **How does job get skillSlug?** (from request, from session, auto-detect)
3. **Should Skill Builder validate YAML against Core ADAS schema?**

---

## Document History

| Date | Change |
|------|--------|
| Jan 14, 2026 | Initial context document created |
| Jan 14, 2026 | Phase 1 COMPLETE: Updated generateDomainYaml() with all 4 Core ADAS fields |
